{{/*
Default Template for SecretProviderClass. All Sub-Charts under this Chart can include the below template.
*/}}
{{- define "parent-chart.secretproviderclass-template" }}
{{- $templateName := .Chart.Name | kebabcase  -}}
{{- $myImageTag := "" -}}
{{ if hasKey .Values.global.imageTags $templateName }}
{{- $myImageTag = get .Values.global.imageTags $templateName -}}
{{- end }}
{{- if hasKey .Values.global.imageTags "all" }}
{{- if eq (get .Values.global.imageTags $templateName)  "general" }}
{{- $myImageTag = get .Values.global.imageTags "all" -}}
{{- end }}
{{- end }}
{{- if ne $myImageTag "" }}
{{- $scopeVars := get $.Values.global.secretProviderClass .Chart.Name -}}
{{- $envValue := "" -}}
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: clientel-general-service-akv-provider
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"          # Set to true for using managed identity
    userAssignedIdentityID: {{ .Values.global.secretProviderClass.managedIdentity }}  # Set the clientID of the user-assigned managed identity to use
    keyvaultName: {{ .Values.global.secretProviderClass.keyvaultName }}        # Set to the name of your key vault
    cloudName: ""                         # [OPTIONAL for Azure] if not provided, the Azure environment defaults to AzurePublicCloud
    objects:  |
      array:
  {{- range $scopeVars | keys | sortAlpha }}
  {{- $scopeValues := get $scopeVars . -}}
  {{- if hasKey $scopeValues $.Values.global.env }}
    {{- $envValue = get $scopeValues $.Values.global.env -}}
  {{- else }}
    {{- $envValue = get $scopeValues "all" -}}
  {{- end }}  
        - |
          objectName: {{ $envValue }}
          objectType: secret              # object types: secret, key, or cert
          objectAlias: "{{ . }}"
          objectVersion: ""               # [OPTIONAL] object versions, default to latest if empty      
  {{- end }}                                
    tenantId: {{ .Values.global.secretProviderClass.tenantId }}                 # The tenant ID of the key vault
        {{- end }}
        {{- end }}    